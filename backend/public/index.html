<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eidolon Prototype</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        section { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 10px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
        .dynamic-field { border-left: 3px solid #007bff; padding-left: 10px; margin-bottom: 10px; }
        .schema-field-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start; border: 1px solid #eee; padding: 10px; border-radius: 4px; }
        .schema-field-row input, .schema-field-row select { width: auto; flex: 1; }
        .remove-btn { background-color: #dc3545; padding: 5px 10px; }
        .remove-btn:hover { background-color: #c82333; }
    </style>
</head>
<body>
    <h1>Eidolon Prototype</h1>

    <!-- Manager Section -->
    <section>
        <h2>Manager: Define Article & Schema</h2>
        <form id="manager-form" onsubmit="createArticle(event)">
            <div class="form-group">
                <label>Organization</label>
                <input type="text" id="mgr-org" value="Acme Corp" required>
            </div>
            <div class="form-group">
                <label>Article Name</label>
                <input type="text" id="mgr-name" placeholder="e.g. Steel Pipe" required>
            </div>
            <div class="form-group">
                <label>Shop Floor Schema (Dynamic Fields)</label>
                <small>Define the fields the operator must fill in.</small>
                <div id="schema-builder"></div>
                <button type="button" onclick="addSchemaField()" style="margin-top: 10px; background-color: #28a745;">+ Add Field</button>
            </div>
            <button type="submit">Create Article</button>
        </form>
        <pre id="mgr-output"></pre>
    </section>

    <!-- Shopfloor Section -->
    <section>
        <h2>Shopfloor: Data Collection</h2>
        <div class="form-group">
            <label>Organization</label>
            <input type="text" id="sf-org" value="Acme Corp">
            <button onclick="loadShopfloorArticles()" style="margin-top: 5px; background-color: #6c757d;">Load Articles</button>
        </div>
        
        <div class="form-group">
            <label>Select Article</label>
            <select id="sf-article-select" onchange="renderShopfloorForm()">
                <option value="">-- Select an Article --</option>
            </select>
        </div>

        <!-- Dynamic Form Container -->
        <div id="sf-dynamic-form"></div>

        <button onclick="registerEntry()" style="margin-top: 20px;">Register Entry</button>
        <pre id="sf-output"></pre>
    </section>

    <script>
        let currentArticles = [];
        let currentSchema = [];

        // --- Manager Functions ---

        function addSchemaField() {
            const container = document.getElementById('schema-builder');
            const id = Date.now();
            const div = document.createElement('div');
            div.className = 'schema-field-row';
            div.id = `field-row-${id}`;
            
            div.innerHTML = `
                <div style="flex: 2">
                    <label>Label</label>
                    <input type="text" class="field-label" placeholder="e.g. Weight" oninput="updateKey(this, '${id}')" required>
                </div>
                <div style="flex: 2">
                    <label>Key (Auto)</label>
                    <input type="text" class="field-key" id="key-${id}" readonly style="background: #f9f9f9">
                </div>
                <div style="flex: 1">
                    <label>Type</label>
                    <select class="field-type" onchange="toggleOptions(this, '${id}')">
                        <option value="text">Text</option>
                        <option value="number">Number</option>
                        <option value="select">Select</option>
                        <option value="boolean">Boolean</option>
                    </select>
                </div>
                <div style="flex: 1">
                    <label>Required</label>
                    <input type="checkbox" class="field-required" style="width: 20px; height: 20px; margin-top: 5px;">
                </div>
                <div style="flex: 2; display: none;" id="options-wrapper-${id}">
                    <label>Options</label>
                    <div id="options-list-${id}"></div>
                    <button type="button" onclick="addOptionInput('${id}')" style="padding: 2px 5px; font-size: 12px; margin-top: 5px;">+ Add Option</button>
                </div>
                <button type="button" class="remove-btn" onclick="removeField('${id}')">X</button>
            `;
            container.appendChild(div);
        }

        function addOptionInput(fieldId) {
            const container = document.getElementById(`options-list-${fieldId}`);
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.marginBottom = '5px';
            div.innerHTML = `
                <input type="text" class="option-value" placeholder="Value" style="flex: 1; margin-right: 5px;" required>
                <button type="button" onclick="this.parentElement.remove()" style="background: #dc3545; color: white; border: none; cursor: pointer; padding: 0 5px;">x</button>
            `;
            container.appendChild(div);
        }

        function removeField(id) {
            document.getElementById(`field-row-${id}`).remove();
        }

        function updateKey(input, id) {
            const keyInput = document.getElementById(`key-${id}`);
            keyInput.value = input.value.toLowerCase().replace(/[^a-z0-9]/g, '_');
        }

        function toggleOptions(select, id) {
            const wrapper = document.getElementById(`options-wrapper-${id}`);
            wrapper.style.display = select.value === 'select' ? 'block' : 'none';
        }

        async function createArticle(event) {
            event.preventDefault(); // Prevent form submission

            const org = document.getElementById('mgr-org').value;
            const name = document.getElementById('mgr-name').value;
            
            // Build Schema from UI
            const schema = [];
            const rows = document.querySelectorAll('.schema-field-row');
            let isValid = true;
            const usedKeys = new Set();
            
            rows.forEach(row => {
                if (!isValid) return;

                const label = row.querySelector('.field-label').value.trim();
                const key = row.querySelector('.field-key').value.trim();
                const type = row.querySelector('.field-type').value;
                const required = row.querySelector('.field-required').checked;

                // Duplicate Key Check
                if (usedKeys.has(key)) {
                    alert(`Duplicate field key detected: '${key}'. Please use unique labels.`);
                    isValid = false;
                    return;
                }
                usedKeys.add(key);

                const fieldDef = {
                    key,
                    label,
                    type,
                    validation: { required }
                };

                if (type === 'select') {
                    const optionInputs = row.querySelectorAll('.option-value');
                    const options = Array.from(optionInputs).map(input => input.value.trim()).filter(v => v);
                    
                    if (options.length === 0) {
                        alert(`Field '${label}' is a Select type but has no options.`);
                        isValid = false;
                        return;
                    }
                    fieldDef.validation.options = options;
                }

                schema.push(fieldDef);
            });

            if (!isValid) return;

            const payload = {
                organization: org,
                name: name,
                status: "active",
                shopFloorSchema: schema,
                attributeSchema: []
            };

            const res = await fetch('/api/articles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            document.getElementById('mgr-output').textContent = JSON.stringify(data, null, 2);
            
            // Refresh shopfloor list if org matches
            if (document.getElementById('sf-org').value === org) {
                loadShopfloorArticles();
            }
        }

        // --- Shopfloor Functions ---

        async function loadShopfloorArticles() {
            const org = document.getElementById('sf-org').value;
            const res = await fetch(`/api/articles?organization=${org}&status=active`);
            const data = await res.json();
            currentArticles = data.articles;
            
            const select = document.getElementById('sf-article-select');
            select.innerHTML = '<option value="">-- Select an Article --</option>';
            
            currentArticles.forEach(article => {
                const option = document.createElement('option');
                option.value = article.id;
                option.text = article.name;
                select.add(option);
            });
            
            document.getElementById('sf-dynamic-form').innerHTML = '';
        }

        function renderShopfloorForm() {
            const articleId = document.getElementById('sf-article-select').value;
            const container = document.getElementById('sf-dynamic-form');
            container.innerHTML = '';

            const article = currentArticles.find(a => a.id === articleId);
            if (!article || !article.shopFloorSchema) return;

            currentSchema = article.shopFloorSchema;

            // Generate HTML for each field in the schema
            currentSchema.forEach(field => {
                const div = document.createElement('div');
                div.className = 'form-group dynamic-field';
                
                const label = document.createElement('label');
                label.textContent = field.label;
                div.appendChild(label);

                let input;
                if (field.type === 'select') {
                    input = document.createElement('select');
                    input.id = `field-${field.key}`;
                    field.validation.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.text = opt;
                        input.add(option);
                    });
                } else {
                    input = document.createElement('input');
                    input.id = `field-${field.key}`;
                    input.type = field.type === 'number' ? 'number' : 'text';
                }
                
                div.appendChild(input);
                container.appendChild(div);
            });
        }

        async function registerEntry() {
            const articleId = document.getElementById('sf-article-select').value;
            const org = document.getElementById('sf-org').value;

            if (!articleId) {
                alert("Please select an article");
                return;
            }

            // Collect data from dynamic inputs
            const collectedData = {};
            currentSchema.forEach(field => {
                const input = document.getElementById(`field-${field.key}`);
                let value = input.value;
                
                if (field.type === 'number') {
                    value = value === '' ? null : Number(value);
                }
                
                collectedData[field.key] = value;
            });

            const res = await fetch('/api/entries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    articleId, 
                    organization: org, 
                    data: collectedData 
                })
            });
            
            const result = await res.json();
            
            if (res.ok) {
                document.getElementById('sf-output').textContent = "Success:\n" + JSON.stringify(result, null, 2);
                document.getElementById('sf-output').style.color = "green";
            } else {
                document.getElementById('sf-output').textContent = "Error:\n" + JSON.stringify(result, null, 2);
                document.getElementById('sf-output').style.color = "red";
            }
        }
    </script>
</body>
</html>